import{d as te,u as B,r as ne,a as oe,b as Q,c as N,o as ie,_ as se,e as ae,f as q,g as R,n as re,F as de,h as w,i as L,j as H,w as V,T as W,t as ce,k as Z,p as pe,l as le,m as ue,q as fe,s as we,v as ve,x as F,y as D,z as he,A as J,B as me}from"./CgsqtpGp.js";import{q as ye,u as _e}from"./Cq5i7OiK.js";import"./0TEWubAI.js";const ge={nuxt:{}},ke=te(ge);function X(){const o=B();return o._appConfig||(o._appConfig=ne(ke)),o._appConfig}const T=o=>(pe("data-v-0787724d"),o=o(),le(),o),Ce=T(()=>w("svg",{viewBox:"0 0 90 90",fill:"none",xmlns:"http://www.w3.org/2000/svg"},[w("path",{d:"M50.0016 71.0999h29.2561c.9293.0001 1.8422-.241 2.6469-.6992.8047-.4582 1.4729-1.1173 1.9373-1.9109.4645-.7936.7088-1.6939.7083-2.6102-.0004-.9162-.2455-1.8163-.7106-2.6095L64.192 29.713c-.4644-.7934-1.1325-1.4523-1.937-1.9105-.8046-.4581-1.7173-.6993-2.6463-.6993-.9291 0-1.8418.2412-2.6463.6993-.8046.4582-1.4726 1.1171-1.937 1.9105l-5.0238 8.5861-9.8224-16.7898c-.4648-.7934-1.1332-1.4522-1.938-1.9102-.8047-.4581-1.7176-.6992-2.6468-.6992-.9292 0-1.842.2411-2.6468.6992-.8048.458-1.4731 1.1168-1.9379 1.9102L6.56062 63.2701c-.46512.7932-.71021 1.6933-.71061 2.6095-.00041.9163.24389 1.8166.70831 2.6102.46443.7936 1.1326 1.4527 1.93732 1.9109.80473.4582 1.71766.6993 2.64686.6992h18.3646c7.2763 0 12.6422-3.1516 16.3345-9.3002l8.9642-15.3081 4.8015-8.1925 14.4099 24.6083H54.8058l-4.8042 8.1925ZM29.2077 62.899l-12.8161-.0028L35.603 30.0869l9.5857 16.4047-6.418 10.9645c-2.4521 3.9894-5.2377 5.4429-9.563 5.4429Z",fill:"currentColor"})],-1)),Ie=T(()=>w("span",null,[w("a",{href:"https://nuxt.studio",target:"_blank",rel:"noopener"},"Nuxt Studio"),ue(": Preview enabled")],-1)),Pe={key:0},xe=T(()=>w("div",{id:"__preview_background"},null,-1)),Se=T(()=>w("svg",{id:"__preview_loading_icon",width:"32",height:"32",viewBox:"0 0 24 24"},[w("path",{fill:"none",stroke:"currentColor","stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M4 4v5h.582m15.356 2A8.001 8.001 0 0 0 4.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 0 1-15.357-2m15.357 2H15"})],-1)),Te=T(()=>w("p",null,"Initializing the preview...",-1)),Ae={key:0},be=T(()=>w("div",{id:"__preview_background"},null,-1)),qe={id:"__preview_loader"},Re=oe({__name:"ContentPreviewMode",props:{previewToken:{type:String,required:!0},apiURL:{type:String,required:!0},syncPreview:{type:Function,required:!0},requestPreviewSyncAPI:{type:Function,required:!0}},setup(o){const a=o,r=["__nuxt_preview","__preview_enabled"],p=B(),m=Q(),f=N(!0),g=N(!1),e=N(!1),u=N("");let d;const v=async()=>{Z("previewToken").value="",window.sessionStorage.removeItem("previewToken"),window.sessionStorage.removeItem("previewAPI"),await m.replace({query:{preview:void 0}}),window.location.reload()},A=async P=>{const y=await a.syncPreview(P);if(e.value!==!0){if(!y){setTimeout(()=>A(P),1e3);return}Z("previewToken").value&&(e.value=!0,await m.replace({query:{}}),p.callHook("nuxt-studio:preview:ready"),window.parent&&window.self!==window.parent&&d.disconnect())}};return ie(async()=>{d=(await se(()=>import("./CF3NOiUn.js"),[],import.meta.url)).connect(`${a.apiURL}/preview`,{transports:["websocket","polling"],auth:{token:a.previewToken}});let y;d.on("connect",()=>{y=setTimeout(()=>{e.value||(y=setTimeout(()=>{u.value="Preview sync timed out",e.value=!1},3e4),d.emit("draft:requestSync"))},3e4)});const _=()=>{y&&(clearTimeout(y),y=null)};d.on("draft:sync",async x=>{if(_(),!x){try{d.once("draft:ready",()=>{d.emit("draft:requestSync")}),await a.requestPreviewSyncAPI()}catch($){switch(_(),$.response.status){case 404:u.value="Preview draft not found",e.value=!1;break;default:u.value="An error occurred while syncing preview",e.value=!1}}return}A(x)}),d.on("draft:unauthorized",()=>{_(),u.value="Unauthorized preview token",e.value=!1}),d.on("disconnect",()=>{_()}),document.body.classList.add(...r),d.on("draft:update",x=>{g.value=!0,a.syncPreview(x),g.value=!1})}),ae(()=>{document.body.classList.remove(...r)}),(P,y)=>(q(),R("div",null,[f.value?(q(),R("div",{key:0,id:"__nuxt_preview",class:re({__preview_ready:e.value,__preview_refreshing:g.value})},[e.value?(q(),R(de,{key:0},[Ce,Ie,w("button",{onClick:v}," Close ")],64)):L("",!0)],2)):L("",!0),H(W,{name:"preview-loading"},{default:V(()=>[f.value&&!e.value&&!u.value?(q(),R("div",Pe,[xe,w("div",{id:"__preview_loader"},[Se,Te,w("button",{onClick:v}," Cancel ")])])):L("",!0)]),_:1}),H(W,{name:"preview-loading"},{default:V(()=>[u.value?(q(),R("div",Ae,[be,w("div",qe,[w("p",null,ce(u.value),1),w("button",{onClick:v}," Exit preview ")])])):L("",!0)]),_:1})]))}}),Ne=fe(Re,[["__scopeId","data-v-0787724d"]]),$e=(o=[],a,r)=>{const p=[...a||[]],m=[...r||[]],f=JSON.parse(JSON.stringify(o));for(const e of p)if(e.new)f.push({path:e.path,parsed:e.parsed});else if(e.oldPath)if(m.splice(m.findIndex(d=>d.path===e.oldPath),1),p.find(d=>d.path===e.oldPath))f.push({path:e.path,parsed:e.parsed});else{const d=f.find(v=>v.path===e.oldPath);d&&(d.path=e.path,e.parsed?d.parsed=e.parsed:e.pathMeta&&["_file","_path","_id","_locale"].forEach(v=>{d.parsed[v]=e.pathMeta[v]}))}else{const u=f.find(d=>d.path===e.path);u?Object.assign(u,{path:e.path,parsed:e.parsed}):f.push({path:e.path,parsed:e.parsed})}for(const e of m)f.splice(f.findIndex(u=>u.path===e.path),1);const g=new Intl.Collator(void 0,{numeric:!0});return f.sort((e,u)=>g.compare(e.path,u.path)),f},C={appConfig:"app.config.ts",nuxtConfig:"nuxt.config.ts",tokensConfig:"tokens.config.ts"},Oe=o=>{let a;return r=>(a||(a=o()),a)};function Y(o,a){for(const r in o){const p=a[r];r in a||delete o[r],p!==null&&typeof p=="object"&&Y(o[r],a[r])}}function j(o,a){for(const r in a){const p=a[r];p!==null&&typeof p=="object"?Array.isArray(p)&&Array.isArray(o[r])?o[r]=p:(o[r]=o[r]||{},j(o[r],p)):o[r]=p}}const Me=Oe(()=>JSON.parse(JSON.stringify(X()))),G=me((o,a,r)=>{if(Array.isArray(o[a])&&Array.isArray(r))return o[a]=r,!0});let U=[];const Je=()=>{const o=B(),{studio:a,content:r}=we().public,p={},m=window.sessionStorage.getItem("previewAPI")||(a==null?void 0:a.apiURL),f=Me();let g;const e=ve("studio-client-db",()=>null);e.value||(o.hook("content:storage",n=>{e.value=n}),ye("/non-existing-path").findOne());const u=async(n,i)=>{const s=window.sessionStorage.getItem("previewToken"),c=await n.getKeys(`${s}:`);await Promise.all(c.map(t=>n.removeItem(t)));const l=new Set(i.map(t=>t.parsed._id.split(":").shift()));await n.setItem(`${s}$`,JSON.stringify({ignoreSources:Array.from(l)})),await Promise.all(i.map(t=>(p[t.parsed._path]=t.parsed,n.setItem(`${s}:${t.parsed._id}`,JSON.stringify(t.parsed)))))},d=n=>{const i=D(o,X);i!=null&&i.ui&&(i.ui.icons={...i.ui.icons,dynamic:!0}),j(i,G(n,f)),n||Y(i,f)},v=n=>{var s,c,l,t;const i=(t=(l=(c=(s=o==null?void 0:o.vueApp)==null?void 0:s._context)==null?void 0:c.config)==null?void 0:l.globalProperties)==null?void 0:t.$pinceauTheme;!i||!(i!=null&&i.updateTheme)||(g||(g=JSON.parse(JSON.stringify((i==null?void 0:i.theme).value||{}))),D(o,i.updateTheme,[G(n,g)]))},A=async n=>{if(U=n.files=n.files||U||[],!e.value)return!1;U=[];const i=$e(n.files,n.additions,n.deletions),s=i.filter(t=>![C.appConfig,C.nuxtConfig,C.tokensConfig].includes(t.path));await u(e.value,s);const c=i.find(t=>t.path===C.appConfig);d(c==null?void 0:c.parsed);const l=i.find(t=>t.path===C.tokensConfig);return v(l==null?void 0:l.parsed),O(),!0},P=async()=>{const n=window.sessionStorage.getItem("previewToken");await $fetch("api/projects/preview/sync",{baseURL:m,method:"POST",params:{token:n}})},y=()=>{const n=window.sessionStorage.getItem("previewToken"),i=document.createElement("div");i.id="__nuxt_preview_wrapper",document.body.appendChild(i),he(Ne,{previewToken:n,apiURL:m,syncPreview:A,requestPreviewSyncAPI:P}).mount(i)},_=async n=>{var c,l,t;const i=window.sessionStorage.getItem("previewToken");if(!n)return null;n=n.replace(/\/$/,"");let s=await((c=e.value)==null?void 0:c.getItem(`${i}:${n}`));return s||(s=await((l=e.value)==null?void 0:l.getItem(`cached:${n}`))),s||(s=s=await((t=e.value)==null?void 0:t.getItem(n))),s||(s=p[n||"/"]),s},x=n=>{var s;const i=window.sessionStorage.getItem("previewToken");e.value&&(p[n.parsed._path]=n.parsed,e.value.setItem(`${i}:${(s=n.parsed)==null?void 0:s._id}`,JSON.stringify(n.parsed)))},$=async n=>{var c;const i=window.sessionStorage.getItem("previewToken"),s=await _(n);if(await((c=e.value)==null?void 0:c.removeItem(`${i}:${n}`)),s){delete p[s._path];const l=await _(s._id);l&&(p[l._path]=l)}},O=async()=>{if(r!=null&&r.documentDriven){const{pages:n}=D(o,_e),i=await Promise.all(Object.keys(n.value).map(async s=>{var c;return await _(((c=n.value[s])==null?void 0:c._id)??s)}));n.value=i.reduce((s,c,l)=>(c&&(s[Object.keys(n.value)[l]]=c),s),{})}await o.hooks.callHookParallel("app:data:refresh")};return{apiURL:m,contentStorage:e,syncPreviewFiles:u,syncPreviewAppConfig:d,syncPreviewTokensConfig:v,requestPreviewSynchronization:P,findContentWithId:_,updateContent:x,removeContentWithId:$,requestRerender:O,mountPreviewUI:y,initiateIframeCommunication:ee};function ee(){if(!window.parent||window.self===window.parent)return;const n=Q(),i=F(),s=N(""),c=t=>({path:t.path,query:J(t.query),params:J(t.params),fullPath:t.fullPath,meta:J(t.meta)});window.addEventListener("keydown",t=>{(t.metaKey||t.ctrlKey||t.altKey||t.shiftKey)&&window.parent.postMessage({type:"nuxt-studio:preview:keydown",payload:{key:t.key,metaKey:t.metaKey,ctrlKey:t.ctrlKey,shiftKey:t.shiftKey,altKey:t.altKey}},"*")}),window.addEventListener("message",async t=>{var z;if(!["https://nuxt.studio","https://new.nuxt.studio","https://new.dev.nuxt.studio","https://dev.nuxt.studio","http://localhost:3000",...((z=a==null?void 0:a.iframeMessagingAllowedOrigins)==null?void 0:z.split(",").map(h=>h.trim()))||[]].includes(t.origin))return;const{type:E,payload:b={}}=t.data||{};switch(E){case"nuxt-studio:editor:file-selected":{const h=await _(b.path);h&&(h._partial||!String(b.path).endsWith(".md")||h._path!==F().path&&(s.value=h._path,n.push(h._path)));break}case"nuxt-studio:editor:file-changed":{const{additions:h=[],deletions:M=[]}=b;for(const I of h)await x(I);for(const I of M)await $(I.path);O();break}case"nuxt-studio:preview:sync":{A(b);break}case"nuxt-studio:config:file-changed":{const{additions:h=[],deletions:M=[]}=b,I=h.find(S=>S.path===C.appConfig);I&&d(I==null?void 0:I.parsed),M.find(S=>S.path===C.appConfig)&&d(void 0);const K=h.find(S=>S.path===C.tokensConfig);K&&v(K==null?void 0:K.parsed),M.find(S=>S.path===C.tokensConfig)&&v(void 0);break}}}),o.hook("page:finish",()=>{l(),o.payload.prerenderedAt&&O()}),o.hook("content:document-driven:finish",({route:t,page:k})=>{t.meta.studio_page_contentId=k==null?void 0:k._id}),o.hook("nuxt-studio:preview:ready",()=>{window.parent.postMessage({type:"nuxt-studio:preview:ready",payload:c(F())},"*"),setTimeout(()=>{l()},100)});function l(){const t=Array.from(window.document.querySelectorAll("[data-content-id]")).map(E=>E.getAttribute("data-content-id")),k=Array.from(new Set([i.meta.studio_page_contentId,...t])).filter(Boolean);if(s.value===k[0]){s.value="";return}window.openContentInStudioEditor(k,{navigate:!0,pageContentId:i.meta.studio_page_contentId})}window.openContentInStudioEditor=(t,k={})=>{window.parent.postMessage({type:"nuxt-studio:preview:navigate",payload:{...c(i),contentIds:t,...k}},"*")}}};export{Je as useStudio};
